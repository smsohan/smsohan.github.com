---
layout: post
title: "Showing unread posts/comments: An example of rails ActiveRecord 'touch'"
date: 2009-09-21
comments: false
categories:
 - Ruby
 - Rails
---

<div class='post'>
I worked on the following story:-<blockquote><div></div><div><span class="Apple-style-span" style="font-weight: bold;">"As a</span> partner, <span class="Apple-style-span" style="font-weight: bold;">when</span> I visit a project's dashboard I <span class="Apple-style-span" style="font-weight: bold;">want</span> to see five most recently started or updated discussion threads with number of unread comments, if any. If any of these are new, I want to see them in a highlighted view. Next, if I open the thread, I want to see all new comments in a highlighted view as well. However, once seen, the threads/comments should no longer be highlighted from the rest."</div></blockquote><div></div><div>I used the following steps to implement this.<br /></div><div><br /></div><div><span class="Apple-style-span" style="font-weight: bold;">Step#1: Added a model MessageReadTime (message_id, user_id, last_read_at)</span></div><div><pre class="brush: rails">class Message <br />has_many :messages_read_times <br />end</pre></div><div><span class="Apple-style-span" style="font-weight: bold;">Step#2: Added filters in the messages_controller</span></div><div><pre class="brush: rails">after_filter :update_message_read_time, :only => [:show]<br />def update_message_read_time<br />read_time = MessageReadTime.find_or_create_by_message_id_and_user_id( params[:id], current_user.id)<br />read_time.last_read_at = Time.now<br />read_time.save!<br />end</pre></div><div><span class="Apple-style-span" style="font-weight: bold;">Step#3: Added :touch=>true and unread? function in Comment class</span></div><div><pre class="brush: rails">class Comment<br />..<br />belongs_to :message, :touch => true<br />def unread?(user)<br /> read_time = self.message.message_read_times.find_by_user_id(user_id)<br /> return true unless(read_time)<br /> return read_time.last_read_at < (updated_at || created_at)       end   end</pre></div><div><span class="Apple-style-span" style="font-weight: bold;">Step#4: Added unread_comments method in Message class like this</span></div><div><pre class="brush:rails">class Message<br />...<br />def unread_comments(user)<br />self.comments.collect{|comment| comment.unread?(user) ? comment : nil }.compact<br />end<br /><br />def unread?(user)<br />read_time = self.message_read_times.find_by_user_id(user.id)<br />return true unless read_time<br />return self.updated_at >= read_time.last_read_at<br />end<br />...<br />end</pre></div><div>This is it! If you know a better way to do this, lets discuss in the comments. You are also welcome to share your thoughts/suggestions :-)</div></div>
