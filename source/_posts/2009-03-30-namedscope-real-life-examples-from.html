---
layout: post
title: "named_scope : Real life examples from ScrumPad"
date: 2009-03-30
comments: false
categories:
 - Ruby
 - Rails
---

<div class='post'>
<p>I am working on ScrumPad chat refactoring now. In rails 2, the named_scope feature works really great for ActiveRecord models. Lets start with the code first-</p>  <p><strong><span style="color: rgb(0, 128, 0);">The Source Code:</span></strong></p>  <div class="code_div">  <p><span style="font-family:Courier New;"><span style="color: rgb(0, 0, 128);">class</span> <strong><span style="color: rgb(0, 0, 255);">ChatUser</span></strong> &lt; ActiveRecord::Base    <br />belongs_to <span style="color: rgb(128, 0, 0);">:chat</span>    <br />belongs_to <span style="color: rgb(128, 0, 0);">:user</span>    <br />belongs_to <span style="color: rgb(128, 0, 0);">:chat_status, :foreign_key</span> =&gt; "status_id" </span></p>  <p><span style="font-family:Courier New;">  named_scope <span style="color: rgb(128, 0, 0);">:closed</span>, lambda {|chat_id| {<span style="color: rgb(128, 0, 0);">:conditions</span> =&gt; ["status_id = #{ChatStatus::CLOSED} AND chat_id = ? ", chat_id]}} do    <br />  <span style="color: rgb(0, 0, 128);">def</span> invite()    <br />    each { |chat_user| chat_user.update_attribute(<span style="color: rgb(128, 0, 0);">:status_id</span>, ChatStatus::INVITED) }    <br />  <span style="color: rgb(0, 0, 128);">end</span>    <br /><span style="color: rgb(0, 0, 128);">end</span> </span></p>   <p><span style="font-family:Courier New;">  named_scope <span style="color: rgb(128, 0, 0);">:active_chats</span>, lambda {|user_id| {<span style="color: rgb(128, 0, 0);">:conditions </span>=&gt; ["user_id = ? AND status_id not in (#{ChatStatus::CLOSED}, #{ChatStatus::LEFT})", user_id]}}    <br />named_scope <span style="color: rgb(128, 0, 0);">:with_chat</span>, <span style="color: rgb(128, 0, 0);">:include</span> =&gt; <span style="color: rgb(128, 0, 0);">:chat</span>    <br /><span style="color: rgb(0, 0, 128);">end</span></span>  </p> </div> <p>So, you get an idea about the <span style="font-family:Courier New;">ChatUser</span> class. Its a relation object between user, chat and chat_status with some additional fields.</p>  <p><strong><span style="color: rgb(0, 128, 0);">How am I Using My named_scope?</span></strong></p>  <p><span style="font-family:Courier New;">ChatUser.closed(chat_id)</span></p>  <p>Gives me all the chat users who closed their chat windows for the chat having chat_id.</p>  <p><span style="font-family:Courier New;">ChatUser.closed(chat_id).with_chat</span></p>  <p>Gives me the same objects as previous but eager loads the chat object. So, it saves plenty of database calls when I need to iterate through the chats!</p>  <p><span style="font-family:Courier New;">ChatUser.closed(chat_id).invite()</span></p>  <p>Invites all users to a chat with chat_id if the buddy closed the chat window.</p>  <p><strong><span style="color: rgb(0, 128, 0);">Why named_scope?</span></strong></p>  <ol>   <li>named_scope is not just a syntactic sugar. It generates much less query using WHERE IN clause instead of WHERE = clause. So, reduces the number of calls to a single call. </li>    <li>Chaining the named_scope will generate only a single query for the chain. So, ChatUser.closed(chat_id).with_chat will produce only one query. </li>    <li>You get rid of looping in many cases! It will help you to write concise and clear codes. </li>    <li>When you can divide the objects in your classes in partitions, then you may wish to write the named_scope for partitioning the data. In my example, the :closed named_scope does this. So, I can add methods to this named_scope which actually works for the closed chats. It is kind of dividing your objects into named groups. So, it increases readability. </li> </ol>  <p>Let me know if you have another good example of a real life named_scope in your project.</p></div>
