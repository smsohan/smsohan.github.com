---
layout: post
title: "[ThreadStatic] - A cool Attribute to Thread Safe static members"
date: 2008-06-10
comments: false
categories:
 - C#
 - .Net
---

<div class='post'>
<p>Usually static variables holds the same value for all the threads running at the same AppDommain. However, in a multithreaded scenario, you may need to add thread safe behavior to your static members so that the value of a static member is same inside only a single thread and across multiple threads the value can be different. In this way you may attain a thread specific or thread scoped storage to use in your application. One example is, in Log4Net you need to use ThreadContext class to store the values to be logged that are thread specific.</p>  <p>.Net framework has a smart and easy way of achieving it through the use of ThreadStaticAttribute class. When you apply this attribute to your static members, it will take care of the thread safety. So, from a sample C# code like the following one, you may define thread safe static members.</p>  <p> </p>  <p></p> <!-- {\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 \cf1 class\cf0  \cf4 Program\par ??\cf0     \{\par ??        [\cf4 ThreadStatic\cf0 ]\par ??        \cf1 private\cf0  \cf1 static\cf0  \cf1 int\cf0 ? x;\par ??\par ??        \cf1 static\cf0  \cf1 void\cf0  Main(\cf1 string\cf0 [] args)\par ??        \{\par ??            \cf4 Thread\cf0  [] threads = \cf1 new\cf0  \cf4 Thread\cf0 [5];\par ??            \cf1 for\cf0  (\cf1 int\cf0  i = 0; i < initial     =" \{1\}" x =" (\cf1" after       =" \{1\}">  <div    style="background: white none repeat scroll 0% 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;font-family:courier new;font-size:10pt;color:black;">   <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">    9</span> <span style="color:blue;">class</span> <span style="color: rgb(43, 145, 175);">Program</span></p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   10</span>     {</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   11</span>         [<span style="color: rgb(43, 145, 175);">ThreadStatic</span>]</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   12</span>         <span style="color:blue;">private</span> <span style="color:blue;">static</span> <span style="color:blue;">int</span>? x;</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   13</span> </p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   14</span>         <span style="color:blue;">static</span> <span style="color:blue;">void</span> Main(<span style="color:blue;">string</span>[] args)</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   15</span>         {</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   16</span>             <span style="color: rgb(43, 145, 175);">Thread</span> [] threads = <span style="color:blue;">new</span> <span style="color: rgb(43, 145, 175);">Thread</span>[5];</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   17</span>             <span style="color:blue;">for</span> (<span style="color:blue;">int</span> i = 0; i &lt; threads.Length; i++)</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   18</span>             {</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   19</span>                 threads[i] = <span style="color:blue;">new</span> <span style="color: rgb(43, 145, 175);">Thread</span>(<span style="color:blue;">new</span> <span style="color: rgb(43, 145, 175);">ParameterizedThreadStart</span>(<span style="color: rgb(43, 145, 175);">Program</span>.Run));</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   20</span>                 threads[i].Start(i);</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   21</span>             }</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   22</span>             <span style="color: rgb(43, 145, 175);">Console</span>.Read();</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   23</span>         }</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   24</span> </p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   25</span>         <span style="color:blue;">public</span> <span style="color:blue;">static</span> <span style="color:blue;">void</span> Run(<span style="color:blue;">object</span> i)</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   26</span>         {</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   27</span>             <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"From Thread {0}: Initial    = {1}"</span>, i, x);</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   28</span>             x = (<span style="color:blue;">int</span>)i;</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   29</span>             <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"From Thread {0}: After       = {1}"</span>, i, x);</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   30</span>             <span style="color: rgb(43, 145, 175);">Thread</span>.Sleep(1000);</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   31</span>         }</p>    <p style="margin: 0px;"><span style="color: rgb(43, 145, 175);">   32</span>     }</p> </div>  <p>The output of this code is-</p>  <p> <a href="http://lh6.ggpht.com/sohan39/SE9kdtZEm0I/AAAAAAAAAC4/6NSlxQeNUos/s1600-h/image%5B3%5D.png"><img style="border: 0px none ;" alt="image" src="http://lh6.ggpht.com/sohan39/SE9kiG2eWvI/AAAAAAAAAC8/lu854e6xQWc/image_thumb%5B1%5D.png?imgmax=800" width="269" border="0" height="144" /></a></p>  <p>From the output its evident that each of the threads sees the initial value to be a null although in some other thread it may have been initialized to some value. So, the thread safety is achieve as easily as shown in the above example.</p>  <p>Have fun with ThreadStatic!</p></div>
